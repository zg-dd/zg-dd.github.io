<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Socket on 小巷的随笔</title><link>https://zg-dd.github.io/tags/socket/</link><description>Recent content in Socket on 小巷的随笔</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Fri, 15 Aug 2025 19:08:51 +0800</lastBuildDate><atom:link href="https://zg-dd.github.io/tags/socket/index.xml" rel="self" type="application/rss+xml"/><item><title>网络通讯核心知识</title><link>https://zg-dd.github.io/stu/socket/</link><pubDate>Fri, 15 Aug 2025 19:08:51 +0800</pubDate><guid>https://zg-dd.github.io/stu/socket/</guid><description>&lt;h1 id="网络通讯核心知识"&gt;网络通讯核心知识
&lt;/h1&gt;&lt;h2 id="一核心概念"&gt;一、核心概念
&lt;/h2&gt;&lt;h3 id="1-socket"&gt;1. Socket
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;是什么&lt;/strong&gt;：进程间通信(IPC)的扩展机制&lt;br&gt;
&lt;strong&gt;用途&lt;/strong&gt;：建立网络通信通道（TCP/UDP）&lt;br&gt;
&lt;strong&gt;流程&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务端：socket → bind → listen → accept&lt;/li&gt;
&lt;li&gt;客户端：socket → connect → write/read → close&lt;br&gt;
&lt;strong&gt;注意事项&lt;/strong&gt;：需处理字节序转换(htonl/ntohl)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="2-tcp-vs-udp"&gt;2. TCP vs UDP
&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;特性&lt;/th&gt;
&lt;th&gt;TCP&lt;/th&gt;
&lt;th&gt;UDP&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;连接方式&lt;/td&gt;
&lt;td&gt;面向连接（三次握手）&lt;/td&gt;
&lt;td&gt;无连接&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;可靠性&lt;/td&gt;
&lt;td&gt;可靠传输（重传机制）&lt;/td&gt;
&lt;td&gt;不可靠传输&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;数据形式&lt;/td&gt;
&lt;td&gt;流式套接字&lt;/td&gt;
&lt;td&gt;数据报套接字&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;适用场景&lt;/td&gt;
&lt;td&gt;文件传输、网页浏览&lt;/td&gt;
&lt;td&gt;实时视频、DNS查询&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id="二服务器模型"&gt;二、服务器模型
&lt;/h2&gt;&lt;h3 id="1-迭代服务器"&gt;1. 迭代服务器
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;缺陷&lt;/strong&gt;：单线程阻塞，无法并发处理请求&lt;/p&gt;
&lt;h3 id="2-进程线程模型"&gt;2. 进程/线程模型
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;进程方案&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;需用waitpid()避免僵尸进程&lt;/li&gt;
&lt;li&gt;注意：子进程结束需父进程回收资源&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;僵尸进程处理详解&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;产生原因&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;子进程终止但未被父进程wait()&lt;/li&gt;
&lt;li&gt;会占用系统进程表资源&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;处理方法&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;同步回收&lt;/strong&gt;：
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-c" data-lang="c"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#a6e22e"&gt;waitpid&lt;/span&gt;(pid, NULL, &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;); &lt;span style="color:#75715e"&gt;// 阻塞等待
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;异步回收&lt;/strong&gt;（推荐）：
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-c" data-lang="c"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#a6e22e"&gt;signal&lt;/span&gt;(SIGCHLD, [](&lt;span style="color:#66d9ef"&gt;int&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;while&lt;/span&gt;(&lt;span style="color:#a6e22e"&gt;waitpid&lt;/span&gt;(&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;, NULL, WNOHANG) &lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;});
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;特殊情形&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;父进程先终止时，僵尸进程由init进程接管并回收&lt;/li&gt;
&lt;li&gt;批量回收时需循环调用waitpid()&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;线程方案&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;需处理共享变量加锁问题&lt;/li&gt;
&lt;li&gt;线程同步更复杂（临界区/锁机制）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="3-进程池优化"&gt;3. 进程池优化
&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;类型&lt;/th&gt;
&lt;th&gt;特点&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;静态进程池&lt;/td&gt;
&lt;td&gt;预创建进程，限制并发上限&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;动态进程池&lt;/td&gt;
&lt;td&gt;维护最小/最大空闲进程数&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id="三高性能io模型"&gt;三、高性能I/O模型
&lt;/h2&gt;&lt;h3 id="1-传统阻塞模型"&gt;1. 传统阻塞模型
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;特点&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;单线程阻塞等待I/O就绪&lt;/li&gt;
&lt;li&gt;资源利用率低&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="2-selectpoll"&gt;2. Select/Poll
&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;特性&lt;/th&gt;
&lt;th&gt;Select&lt;/th&gt;
&lt;th&gt;Poll&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;实现原理&lt;/td&gt;
&lt;td&gt;位图轮询FD(描述符集)&lt;/td&gt;
&lt;td&gt;链表轮询FD(描述符集)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;最大连接数&lt;/td&gt;
&lt;td&gt;1024（FD_SETSIZE限制）&lt;/td&gt;
&lt;td&gt;无硬性限制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;效率缺陷&lt;/td&gt;
&lt;td&gt;O(n)线性扫描&lt;/td&gt;
&lt;td&gt;O(n)线性扫描&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;跨平台性&lt;/td&gt;
&lt;td&gt;所有平台支持&lt;/td&gt;
&lt;td&gt;所有平台支持&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="3-epoll"&gt;3. Epoll
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;核心机制&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;事件注册&lt;/strong&gt;：通过epoll_ctl维护红黑树&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;就绪列表&lt;/strong&gt;：内核维护就绪FD双向链表&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;触发模式&lt;/strong&gt;：
&lt;ul&gt;
&lt;li&gt;LT（Level Trigger）：类似Poll的触发方式&lt;/li&gt;
&lt;li&gt;ET（Edge Trigger）：状态变化时单次通知&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;性能优势&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;O(1)事件通知复杂度&lt;/li&gt;
&lt;li&gt;百万级连接支持（C1000K场景）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="4-nionon-blocking-io"&gt;4. NIO（Non-blocking I/O）
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;核心组件&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Channel&lt;/strong&gt;：全双工通信管道（SocketChannel/FileChannel）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Buffer&lt;/strong&gt;：结构化数据容器（ByteBuffer/CharBuffer）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Selector&lt;/strong&gt;：多路复用器（基于系统epoll/kqueue实现）&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;工作流程&lt;/strong&gt;：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code class="language-plantuml" data-lang="plantuml"&gt;start
: 创建Selector;
: 注册Channel到Selector;
repeat
: select()查询就绪事件;
: 处理SelectionKey事件;
repeat while (有事件?)
stop
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id="5-aioasynchronous-io"&gt;5. AIO（Asynchronous I/O）
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;实现原理&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;内核完成I/O操作后主动回调&lt;/li&gt;
&lt;li&gt;无需用户线程轮询&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;典型场景&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;大文件异步读写&lt;/li&gt;
&lt;li&gt;高延迟网络操作&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="6-完整对比表"&gt;6. 完整对比表
&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;模型&lt;/th&gt;
&lt;th&gt;阻塞性&lt;/th&gt;
&lt;th&gt;线程要求&lt;/th&gt;
&lt;th&gt;触发方式&lt;/th&gt;
&lt;th&gt;适用场景&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;阻塞I/O&lt;/td&gt;
&lt;td&gt;完全阻塞&lt;/td&gt;
&lt;td&gt;1:1&lt;/td&gt;
&lt;td&gt;-&lt;/td&gt;
&lt;td&gt;低并发简单场景&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Select&lt;/td&gt;
&lt;td&gt;非阻塞&lt;/td&gt;
&lt;td&gt;1:N&lt;/td&gt;
&lt;td&gt;轮询通知&lt;/td&gt;
&lt;td&gt;跨平台中等并发&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Poll&lt;/td&gt;
&lt;td&gt;非阻塞&lt;/td&gt;
&lt;td&gt;1:N&lt;/td&gt;
&lt;td&gt;轮询通知&lt;/td&gt;
&lt;td&gt;连接数&amp;lt;10K&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Epoll&lt;/td&gt;
&lt;td&gt;非阻塞&lt;/td&gt;
&lt;td&gt;1:N&lt;/td&gt;
&lt;td&gt;事件驱动&lt;/td&gt;
&lt;td&gt;Linux高并发系统&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;NIO&lt;/td&gt;
&lt;td&gt;非阻塞&lt;/td&gt;
&lt;td&gt;1:N&lt;/td&gt;
&lt;td&gt;就绪选择&lt;/td&gt;
&lt;td&gt;高吞吐应用&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AIO&lt;/td&gt;
&lt;td&gt;异步&lt;/td&gt;
&lt;td&gt;0:1&lt;/td&gt;
&lt;td&gt;完成回调&lt;/td&gt;
&lt;td&gt;延迟敏感型操作&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id="补充说明"&gt;补充说明
&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;内核支持&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Windows：IOCP是真正的异步I/O&lt;/li&gt;
&lt;li&gt;Linux：5.1+内核的io_uring接近真异步&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;性能临界点&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;C10K：Select/Poll达到性能瓶颈&lt;/li&gt;
&lt;li&gt;C100K：必须使用Epoll/NIO&lt;/li&gt;
&lt;li&gt;C1000K：需要Epoll+零拷贝优化&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;编程复杂度&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;阻塞I/O &amp;lt; Select &amp;lt; Poll &amp;lt; Epoll &amp;lt; NIO &amp;lt; AIO&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="四实践要点"&gt;四、实践要点
&lt;/h2&gt;&lt;h3 id="1-守护进程"&gt;1. 守护进程
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;关键步骤&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;fork()&lt;/li&gt;
&lt;li&gt;setsid()&lt;br&gt;
&lt;strong&gt;需重定向&lt;/strong&gt;标准I/O至/dev/null&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="2-udp服务器"&gt;2. UDP服务器
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;特点&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;无需listen()/accept()&lt;/li&gt;
&lt;li&gt;直接使用recvfrom()/sendto()&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="3-其他"&gt;3. 其他
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Reuse Address&lt;/strong&gt;：避免TIME_WAIT状态占用端口&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;惊群效应&lt;/strong&gt;：多进程Accept互相竞争导致，需内核锁优化&lt;br&gt;
&lt;strong&gt;服务器类型&lt;/strong&gt;：&lt;/li&gt;
&lt;li&gt;IO密集型：LNMP(nginx)&lt;/li&gt;
&lt;li&gt;CPU密集型：LAMP(Apache)&lt;/li&gt;
&lt;li&gt;协程：是用户态线程，用户态调度，避免内核切换开销，线程是内核调用。对比线程：切换速度更快，资源消耗更低&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="五学习建议"&gt;五、学习建议
&lt;/h2&gt;&lt;h3 id="1-诊断工具"&gt;1. 诊断工具
&lt;/h3&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;netstat -anp &lt;span style="color:#75715e"&gt;# 查看网络连接&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="2-经典书籍"&gt;2. 经典书籍
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;《Unix网络编程》&lt;/li&gt;
&lt;li&gt;《Unix环境高级编程》&lt;/li&gt;
&lt;/ul&gt;</description></item></channel></rss>